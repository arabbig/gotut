
<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <meta name='description' content='>
    <meta name='author' content='>
    <link rel='shortcut icon' href='favicon.ico'>

    <title>Carousel Template for Bootstrap</title>

    <!-- Bootstrap core CSS -->
    <link href='css/bootstrap.min.css' rel='stylesheet'>

    <!-- Custom styles for this template -->
    <link href='carousel.css' rel='stylesheet'>

    <style type='text/css'>

    svg.template {
      display: none;
    }

    /*
        http://stackoverflow.com/questions/7570917/svg-height-incorrectly-calculated-in-webkit-browsers
    */
    svg.game {
      max-height: 100%; 
    }
    </style>



  </head>
<!-- NAVBAR
================================================== -->
  <body>

    <!-- Remember to include class ='img-responsive game' when instantiating. -->
    <svg class='template' xmlns='http://www.w3.org/2000/svg' version='1.1' viewbox='0 0 108 108'>
      <defs>
          <pattern id='img1' patternUnits='userSpaceOnUse' width='108' height='108'>
            <image xlink:href='retina_wood.png' x='0' y='0' width='108' height='108' />
          </pattern>
          <pattern id='grid' x='6' y='6' patternUnits='userSpaceOnUse' width='12' height='12'>
            <rect stroke='black' strock-width='1' fill='none' x='0' y ='0' width='12' height='12'/>
          </pattern>
          <pattern id='vline' x='6' y='6' patternUnits='userSpaceOnUse' width='12' height='108'>
            <rect stroke='black' strock-width='0.5' fill='none' x='-1' y ='0' width='1' height='108'/>
          </pattern>
          <pattern id='hline' x='6' y='6' patternUnits='userSpaceOnUse' width='108' height='12'>
            <rect stroke='black' strock-width='0.5' fill='none' x='0' y ='-1' width='108' height='1'/>
          </pattern>
      </defs>
      
      <g class='board'>
        <rect  fill='url(#img1)' x='0' y='0' width='108' height='108'/>
        <rect  fill='url(#vline)' stroke='black' x='6' y='6' width='96' height='96'/>
        <rect  fill='url(#hline)' stroke='black' x='6' y='6' width='96' height='96'/>
      </g>

      <g class='stones'></g>

      <g class='screen'>
        <rect  fill='black' x='0' y='0' width='108' height='108' opacity='0.5'/>
          <!-- center (54,54) w/2 = 20  h/2 = 20 -->
        <g transform='translate(34,34)'>
          <circle fill='rgb(0, 173, 239)' cx='20' cy='20' r='15' opacity='0.5'/>
          <g transform='scale(0.7) translate(12,10)'>
            <!-- path fill='none' stroke='#ffffff' d='M6.684,25.682L24.316,15.5L6.684,5.318V25.682Z' stroke-width='3' stroke-linejoin='round' opacity='0' transform='matrix(1,0,0,1,4,4)' style='-webkit-tap-highlight-color: rgba(0, 0, 0, 0); stroke-linejoin: round; opacity: 0;'></path -->
            <path fill='white' stroke='none' d='M6.684,25.682L24.316,15.5L6.684,5.318V25.682Z' transform='matrix(1,0,0,1,4,4)' opacity='1' fill-opacity='1' style='-webkit-tap-highlight-color: rgba(0, 0, 0, 0); opacity: 1; fill-opacity: 1;'></path>
          </g>
        </g>
      </g>

    </svg>


    <!-- Real page start here. -->

    <div class='container marketing'>

      <!-- START THE FEATURETTES -->

      <hr class='featurette-divider'>

      <div class='row featurette'>
        <div class='col-md-7'>
          <h2 class='featurette-heading'>First featurette heading. <span class='text-muted'>It'll blow your mind.</span></h2>
          <p class='lead'>Donec ullamcorper nulla non metus auctor fringilla. Vestibulum id ligula porta felis euismod semper. Praesent commodo cursus magna, vel scelerisque nisl consectetur. Fusce dapibus, tellus ac cursus commodo.</p>
        </div>
        <div class='col-md-5 gameContainer' game-id='atari1'></div>
      </div>

      <hr class='featurette-divider'>

      <div class="row featurette">
        <div class='col-md-5 gameContainer' game-id='atari2'></div>
        <div class="col-md-7">
          <h2 class="featurette-heading">Oh yeah, it's that good. <span class="text-muted">See for yourself.</span></h2>
          <p class="lead">Donec ullamcorper nulla non metus auctor fringilla. Vestibulum id ligula porta felis euismod semper. Praesent commodo cursus magna, vel scelerisque nisl consectetur. Fusce dapibus, tellus ac cursus commodo.</p>
        </div>
      </div>

      <hr class='featurette-divider'>

      <div class='row featurette'>
        <div class='col-md-7'>
           <h2 class="featurette-heading">And lastly, this one. <span class="text-muted">Checkmate.</span></h2>
            <p class="lead">Donec ullamcorper nulla non metus auctor fringilla. Vestibulum id ligula porta felis euismod semper. Praesent commodo cursus magna, vel scelerisque nisl consectetur. Fusce dapibus, tellus ac cursus commodo.</p>        
        </div>
        <div class='col-md-5 gameContainer' game-id='atari3'></div>
      </div>

      <hr class='featurette-divider'> 

      <div class="row featurette">
        <div class='col-md-5 gameContainer' game-id='atari4'></div>
        <div class="col-md-7">
          <h2 class="featurette-heading">Oh yeah, it's that good. <span class="text-muted">See for yourself.</span></h2>
          <p class="lead">Donec ullamcorper nulla non metus auctor fringilla. Vestibulum id ligula porta felis euismod semper. Praesent commodo cursus magna, vel scelerisque nisl consectetur. Fusce dapibus, tellus ac cursus commodo.</p>
        </div>
      </div>

      <hr class='featurette-divider'>
      <!-- /END THE FEATURETTES -->


      <!-- FOOTER -->
      <footer>
        <p class='pull-right'><a href='#'>Back to top</a></p>
        <p>&copy; Charn Pruksapha &middot; <a href='mailto:arabbig@gmail.com'>Email</a></p>
      </footer>

    </div><!-- /.container -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js'></script>
    <script src='js/bootstrap.min.js'></script>
    <script src='docs.min.js'></script>
    <script src='d3.min.js'></script>
    <script src='async.js'></script>

    <script> 


    $(function(){

        /*
          Initialize gameSVG
        */
        $('svg.template')
          .clone()
          .attr('class','game')
          .appendTo('.gameContainer')
          .each(function (){

            var path = $(this).parent().attr('game-id');
            var gameSVG = d3.select(this);

            $.getJSON( path + '.json' , function(snapShots) {

              /*
                Data join key = cross product of stone position
              */
              function key(d) {
                return d.x*1000 + d.y;
              }

              function redraw(stones, op){


                var circles = gameSVG.select('.stones')
                  .selectAll('circle')
                  .data(stones, key);
                  
                switch(op) {
                  case 'initial': //exit.remove enter
                      circles.exit()
                        .transition()
                        .duration(500)
                        .attr('opacity', 0)
                        .remove();
                      circles
                        .transition()
                        .duration(500)
                        .attr('fill', function(d){return d.color});

                  case 'add-incr': //enter
                  case 'add-bulk': //enter
                      circles.enter()
                        .append('circle')
                        .attr('cx', function(d){return d.x})
                        .attr('cy', function(d){return d.y})
                        .attr('r', 5.5)
                        .attr('fill', function(d){return d.color})
                        .attr('opacity', 0)
                        .transition()
                        .duration(500)
                        .attr('opacity', 1);                 
                        break;
                  case 'remove': //exit red remove
                      circles.exit()
                        .attr('fill','red')
                        .transition()
                        .duration(500)
                        .attr('opacity', 0)
                        .remove();
                }

              }

              //////////////////////////////////////////////
              // This part define game view and animation //
              //////////////////////////////////////////////

              /* 
                Initial view
              */
              if(snapShots[0].op != 'initial') {
                throw new UserException("Invalid Snapshots !");
              } else {
                redraw(snapShots[0].stones, snapShots[0].op);
              }

              /*
                Animation play
              */
              function play(){

                // gameSVG, snapShots are assumed

                var currentShot = [];
                var animateQueue = [];

                function pauseAnimation(delay) {
                  animateQueue.push(function(callback) {        
                      setTimeout(function(){ 
                        callback(null, 'Pausing');
                      }, delay);
                  });
                }

                function addSnapshot(stones, op, delay){
                  animateQueue.push(function(callback) {        
                      setTimeout(function(){ 
                        redraw(stones, op);
                        callback(null, 'Animate');
                      }, delay);
                  });
                }
                
                // double loop
                $.each(snapShots, function(i, v){
                  $.each(v.stones, function(ii, vv){

                    if(v.op == 'remove') {
                      currentShot = $.grep(currentShot, function(vvv, iii){
                        return (vvv.x != vv.x) || (vvv.y != vv.y) ;
                      });
                    }
                    else {
                      if(v.op == 'add-bulk' && ii == 0) {
                        currentShot = [];
                        addSnapshot(currentShot.slice(0), 'initial', 1000);
                        pauseAnimation(1000);
                      }
                      currentShot.push(vv) ; // all kind of add
                    }

                    // v.op=add-incr --> incremental, so add one snapshot immediately after push
                    if(v.op == 'add-incr') addSnapshot(currentShot.slice(0), 'add-incr', 1000); 
                    /* Note  slice(0) performs shallow copy */

                  });
                    // remove and the rest are bulk operations
                    if(v.op == 'remove') addSnapshot(currentShot.slice(0), 'remove', 250); 
                    else if(v.op == 'add-bulk') addSnapshot(currentShot.slice(0), 'add-bulk', 1000);
                    else ;// vop=initial operation do nothing
                });

                async.series([start].concat(animateQueue.concat([stop])), function(err, results){
                  console.log(results.join('|'));
                });

                function start(callback) {
                  gameSVG.select('.screen').transition().style('opacity',0);
                  redraw(snapShots[0].stones,snapShots[0].op);
                  callback(null, 'screenFadeOut');
                }

                function stop(callback) {
                  setTimeout(function(){
                    /* Reinitialize initial view again */
                    gameSVG.select('.screen').transition().style('opacity',1);
                    gameSVG.datum({playing:false});
                    //redraw(snapShots[0].stones,snapShots[0].op);
                    callback(null, 'screenFadeIn');
                  }, 1000);

                }

              }

              ///////////////////////////////////////////
              // The rest define interacion with users //
              ///////////////////////////////////////////

              /* 
                Associated boolean indicate playing or idle
              */
              gameSVG.datum({
                playing : false,
              });

              gameSVG.on('click', function(d,i){

                var playing  = gameSVG.datum().playing;
                //console.log(playing);

                if(playing) {
                  // do nothing, already playing
                } else { 
                  // Switch the state
                  gameSVG.datum({playing:true}) ;
                  play();

                }

              });


            }).fail(function(){console.log('fail at JSON loaded');});

          });

    });


    </script>

  </body>
</html>
